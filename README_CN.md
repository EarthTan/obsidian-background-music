# Obsidian Background Music Player

一个专业的 Obsidian 插件，在打开笔记时自动播放背景音乐。每个笔记都可以设置不同的背景音乐，支持智能音量控制和专业级的音频切换体验。现在支持全局背景音乐和设置界面。

## ✨ 核心特性

### 🎵 专业音频体验
- **无杂音渐变** - 使用 Web Audio API 实现样本级平滑渐变
- **智能音量控制** - 支持 0-1 和 1-100 两种音量范围
- **播放进度保存** - 切换笔记时自动保存和恢复播放位置
- **循环播放** - 背景音乐自动循环播放

### 🔄 智能切换管理
- **顺序音频切换** - 等待前一首音乐完全淡出后再播放新音乐
- **窗格智能感知** - 关闭最后一个窗格时自动停止音乐
- **无竞态条件** - Promise 化的音频操作确保切换稳定性

### 🌍 全局背景音乐（新功能）
- **智能切换** - 在无笔记BGM时自动播放全局BGM
- **独立进度** - 全局BGM拥有独立的播放进度记录
- **平滑过渡** - 与笔记BGM之间的无缝音频切换
- **设置界面** - 通过设置界面配置全局BGM参数

### 📁 灵活的音乐源支持
- **本地文件** - 支持相对路径和绝对路径
- **双链引用** - 使用 `[[音乐文件.mp3]]` 格式
- **在线 URL** - 支持 HTTP/HTTPS 在线音乐
- **多种格式** - MP3、WAV、OGG、AAC 等浏览器支持的格式

## 🚀 安装

### 从社区插件安装（推荐）

1. 打开 Obsidian 设置
2. 进入"社区插件"标签页
3. 点击"浏览"按钮
4. 搜索 "Background Music Player"
5. 点击安装
6. 启用插件

### 手动安装

1. 下载插件的最新版本文件
2. 解压到 Obsidian 库的插件文件夹：`.obsidian/plugins/obsidian-backgroud-music/`
3. 重新加载 Obsidian
4. 在社区插件中启用 "Background Music Player"

## 📖 使用方法

### 为笔记添加背景音乐

在笔记的元数据部分添加 `bgm` 或 `BGM` 字段来指定音乐文件路径或 URL：

```yaml
---
title: 我的笔记
bgm: /path/to/music.mp3
loudness: 0.5
---
```

### 音量控制

支持两种音量范围格式：

```yaml
---
bgm: [[music.mp3]]
loudness: 0.3    # 0-1 范围（标准）
---

---
bgm: [[music.mp3]]  
loudness: 50     # 1-100 范围（自动转换为 0.5）
---

---
bgm: [[music.mp3]]
loudness: "75"   # 字符串格式也支持
---
```

### 支持的音乐源格式

1. **本地相对路径**：`music.mp3` 或 `audio/music.mp3`
2. **本地绝对路径**：`/path/to/music.mp3`
3. **Obsidian 双链**：`[[音乐文件.mp3]]`
4. **在线 URL**：`https://example.com/music.mp3`

## 🎯 使用示例

### 基础用法

```yaml
---
title: 学习笔记
bgm: [[study-music.mp3]]
loudness: 0.4
---
```

### 在线音乐

```yaml
---
title: 工作笔记  
bgm: https://example.com/focus-music.mp3
loudness: 60
---
```

### 不同音量设置

```yaml
---
title: 放松笔记
bgm: [[relaxing-music.mp3]]
loudness: 0.2    # 20% 音量
---

---
title: 激励笔记
bgm: [[energetic-music.mp3]]  
loudness: 80     # 80% 音量
---
```

### 全局背景音乐配置

在 Obsidian 设置中配置全局背景音乐：

1. 打开 Obsidian 设置
2. 进入"社区插件" → "BGM-on-open" 设置
3. 启用"Enable Global BGM"
4. 设置全局BGM源（URL、双链或本地路径）
5. 调整全局BGM音量和淡入淡出时长

### 设置界面选项

- **启用全局BGM**：开关全局背景音乐功能
- **全局BGM源**：指定全局背景音乐的文件路径或URL
- **全局BGM音量**：设置全局BGM的音量（0-1或1-100）
- **淡入淡出时长**：音频切换时的渐变时间（秒）

## 🔧 技术特性

### 专业音频处理
- **Web Audio API** - 使用浏览器原生音频引擎
- **GainNode 控制** - 样本级音量渐变，无杂音
- **AudioContext 管理** - 智能的音频上下文生命周期管理
- **Promise 化操作** - 确保音频切换的顺序性

### 智能状态管理
- **Map 存储进度** - 每个文件的播放进度独立保存
- **active-leaf-change 监听** - 感知窗格变化，智能停止音乐
- **file-open 事件** - 传统文件打开事件支持
- **竞态条件防护** - 防止快速切换时的音频重叠

### 用户体验优化
- **初次播放不渐入** - 第一次打开笔记时直接播放
- **后续切换渐入** - 切换笔记时使用平滑渐入效果
- **关闭窗格停止** - 关闭最后一个窗格时自动停止音乐
- **错误容错** - 健壮的音量和路径处理

## 🛠️ 故障排除

### 音乐无法播放

1. **检查文件路径**：确保音乐文件路径正确且文件存在
2. **检查文件权限**：确保 Obsidian 有权限访问音乐文件
3. **检查网络连接**：如果使用在线 URL，确保网络连接正常
4. **检查音频格式**：确保音频格式被浏览器支持

### 播放问题

1. **音量问题**：检查系统音量和浏览器音量设置
2. **播放延迟**：大音频文件可能需要加载时间
3. **切换杂音**：确保使用最新版本，已修复切换时的杂音问题

### 常见问题

**Q: 切换笔记时有"啪"的声音**
A: 已通过顺序音频切换技术解决，确保使用最新版本。

**Q: 关闭笔记后音乐还在播放**
A: 已通过 active-leaf-change 监听解决，插件会智能感知窗格状态。

**Q: 音量设置不生效**
A: 支持 0-1 和 1-100 两种范围，插件会自动转换。

## 🏗️ 开发信息

### 构建插件

```bash
npm install
npm run build
```

### 开发模式

```bash
npm run dev
```

## 📄 许可证

本项目采用 MIT 许可证。详见 [LICENSE](LICENSE) 文件。

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📋 更新日志

### v6.0.0
- **全局背景音乐** - 支持在无笔记BGM时播放全局背景音乐
- **设置界面** - 添加完整的设置界面，支持配置全局BGM参数
- **双播放器架构** - 独立的笔记BGM和全局BGM播放器
- **智能音频切换** - 改进的音频切换逻辑，支持全局与笔记BGM之间的平滑过渡

### v5.0.0
- **专业音频架构** - 使用 AudioBufferSourceNode 实现真正无杂音播放
- **智能音量转换** - 支持 1-100 范围的自动转换
- **窗格智能管理** - 关闭窗格时自动停止音乐
- **顺序音频切换** - Promise 化的切换控制，消除竞态条件

### v3.0.0
- **Web Audio API** - 使用 GainNode 实现样本级音量渐变
- **播放进度保存** - 每个文件的播放进度独立保存
- **智能状态管理** - 改进的音频状态机

### v2.0.0
- **性能优化** - 避免重复创建 Audio 对象
- **requestAnimationFrame** - 更平滑的渐变效果
- **错误容错** - 健壮的音量处理逻辑

### v1.0.0
- 初始版本
- 支持本地文件和在线 URL
- 自动播放功能

---

**注意**：请确保您拥有使用音乐文件的合法权利。本插件仅提供技术功能，不提供任何音乐内容。
